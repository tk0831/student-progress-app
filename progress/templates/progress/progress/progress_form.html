{% extends 'progress/base.html' %}

{% block title %}é€²æ—è¨˜éŒ²{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900">
                    {% if is_edit %}é€²æ—è¨˜éŒ²ã®ç·¨é›†{% else %}ä»Šæ—¥ã®é€²æ—è¨˜éŒ²{% endif %}
                </h1>
                <p class="mt-1 text-sm text-gray-600">å­¦ç¿’å†…å®¹ã¨æ„Ÿæƒ³ã‚’è¨˜éŒ²ã—ã¦ã€ç¶™ç¶šçš„ãªæˆé•·ã‚’è¿½è·¡ã—ã¾ã—ã‚‡ã†ã€‚</p>
            </div>

            <form method="post" class="space-y-8" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒ»é€²æ—çŠ¶æ³ -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ¯ ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒ»é€²æ—çŠ¶æ³</h3>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label for="{{ form.current_phase.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.current_phase.label }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.current_phase }}
                            {% if form.current_phase.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.current_phase.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.current_item.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.current_item.label }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.current_item }}
                            {% if form.current_item.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.current_item.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="{{ form.progress_detail.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.progress_detail.label }}
                        </label>
                        {{ form.progress_detail }}
                        {% if form.progress_detail.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.progress_detail.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- é …ç›®å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                    <div class="mt-4">
                        <label class="inline-flex items-center">
                            {{ form.item_completed }}
                            <span class="ml-2 text-sm font-medium text-blue-700">{{ form.item_completed.label }}</span>
                            <span class="ml-2 text-xs text-blue-600">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡</span>
                        </label>
                    </div>
                </div>

                <!-- å‹‰å¼·æ™‚é–“ -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">â° å‹‰å¼·æ™‚é–“</h3>
                    <div>
                        <label for="{{ form.study_hours.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.study_hours.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.study_hours }}
                        <p class="mt-1 text-sm text-gray-500">0.5æ™‚é–“å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2.5ï¼‰</p>
                        {% if form.study_hours.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.study_hours.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ¤” è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="{{ form.stuck_content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.stuck_content.label }}
                            </label>
                            {{ form.stuck_content }}
                            {% if form.stuck_content.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.stuck_content.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center">
                            {{ form.feedback_requested }}
                            <label for="{{ form.feedback_requested.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                                {{ form.feedback_requested.label }}
                            </label>
                        </div>
                        
                        <div id="feedback-details" class="space-y-4" style="display: none;">
                            <div>
                                <label for="{{ form.problem_detail.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.problem_detail.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.problem_detail }}
                                {% if form.problem_detail.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.problem_detail.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.tried_solutions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.tried_solutions.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.tried_solutions }}
                                {% if form.tried_solutions.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.tried_solutions.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ -->
                            <div>
                                <label for="{{ form.attachment_file.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.attachment_file.label }}
                                </label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-gray-400 transition-colors">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="{{ form.attachment_file.id_for_label }}" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                                <span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                                                {{ form.attachment_file }}
                                            </label>
                                            <p class="pl-1">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                                        </div>
                                        <p class="text-xs text-gray-500">
                                            ZIPå½¢å¼ã®ã¿ã€æœ€å¤§50MB
                                        </p>
                                    </div>
                                </div>
                                {% if form.attachment_file.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.attachment_file.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-xs text-gray-500">
                                    ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãªã©ã‚’ZIPå½¢å¼ã§ã¾ã¨ã‚ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŒ¯ã‚Šè¿”ã‚Šãƒ»åçœç‚¹ -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ’­ æŒ¯ã‚Šè¿”ã‚Šãƒ»åçœç‚¹</h3>
                    <div>
                        <label for="{{ form.reflection.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.reflection.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.reflection }}
                        {% if form.reflection.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.reflection.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- æ¬¡å›ç›®æ¨™ -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ¯ æ¬¡å›ç›®æ¨™</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <label for="{{ form.next_phase.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.next_phase.label }}
                                </label>
                                {{ form.next_phase }}
                                {% if form.next_phase.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.next_phase.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.next_item.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.next_item.label }}
                                </label>
                                {{ form.next_item }}
                                {% if form.next_item.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.next_item.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label for="{{ form.planned_hours.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.planned_hours.label }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.planned_hours }}
                            {% if form.planned_hours.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.planned_hours.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.next_goal.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.next_goal.label }}
                            </label>
                            {{ form.next_goal }}
                            {% if form.next_goal.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.next_goal.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- è¡Œå‹•è¨ˆç”» -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ“‹ è¡Œå‹•è¨ˆç”»</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="{{ form.action_plan.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.action_plan.label }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.action_plan }}
                            {% if form.action_plan.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.action_plan.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="text-sm font-medium text-gray-700">ãƒã‚§ãƒƒã‚¯é …ç›®:</h4>
                            <div class="space-y-2">
                                <label class="inline-flex items-center">
                                    {{ form.need_review }}
                                    <span class="ml-2 text-sm text-gray-700">{{ form.need_review.label }}</span>
                                </label>
                                <label class="inline-flex items-center">
                                    {{ form.have_question }}
                                    <span class="ml-2 text-sm text-gray-700">{{ form.have_question.label }}</span>
                                </label>
                                <label class="inline-flex items-center">
                                    {{ form.next_phase_ready }}
                                    <span class="ml-2 text-sm text-gray-700">{{ form.next_phase_ready.label }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                <div class="pt-6 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <a href="{% url 'student_dashboard' %}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </a>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            é€²æ—ã‚’è¨˜éŒ²
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¸Œæœ›ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ¶å¾¡
    document.addEventListener('DOMContentLoaded', function() {
        const feedbackCheckbox = document.getElementById('{{ form.feedback_requested.id_for_label }}');
        const feedbackDetails = document.getElementById('feedback-details');
        
        function toggleFeedbackDetails() {
            if (feedbackCheckbox.checked) {
                feedbackDetails.style.display = 'block';
            } else {
                feedbackDetails.style.display = 'none';
            }
        }
        
        feedbackCheckbox.addEventListener('change', toggleFeedbackDetails);
        toggleFeedbackDetails(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®åˆ¶å¾¡
        const fileInput = document.getElementById('{{ form.attachment_file.id_for_label }}');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ50MBï¼‰
                    if (file.size > 50 * 1024 * 1024) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯50MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚');
                        e.target.value = '';
                        return;
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
                    if (!file.name.toLowerCase().endsWith('.zip')) {
                        alert('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚');
                        e.target.value = '';
                        return;
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
                    const label = e.target.closest('.space-y-1').querySelector('span');
                    if (label) {
                        label.textContent = file.name;
                    }
                }
            });
        }
        
        // Phaseé¸æŠæ™‚ã«é …ç›®ã‚’å‹•çš„ã«æ›´æ–°
        const currentPhaseSelect = document.getElementById('{{ form.current_phase.id_for_label }}');
        const currentItemSelect = document.getElementById('{{ form.current_item.id_for_label }}');
        const nextPhaseSelect = document.getElementById('{{ form.next_phase.id_for_label }}');
        const nextItemSelect = document.getElementById('{{ form.next_item.id_for_label }}');
        
        function updateItems(phaseSelect, itemSelect, selectedValue = null) {
            const phaseId = phaseSelect.value;
            const currentSelected = selectedValue || itemSelect.value;
            
            // é …ç›®é¸æŠã‚’ã‚¯ãƒªã‚¢
            itemSelect.innerHTML = '<option value="">---------</option>';
            
            if (phaseId) {
                // AJAX call to get items for selected phase
                fetch(`/api/phase-items/?phase_id=${phaseId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.items) {
                            data.items.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.id;
                                option.textContent = item.display;
                                if (item.id.toString() === currentSelected) {
                                    option.selected = true;
                                }
                                itemSelect.appendChild(option);
                            });
                        } else if (data.error) {
                            console.error('Error loading items:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        }
        
        if (currentPhaseSelect) {
            currentPhaseSelect.addEventListener('change', function() {
                updateItems(currentPhaseSelect, currentItemSelect);
            });
        }
        
        if (nextPhaseSelect) {
            nextPhaseSelect.addEventListener('change', function() {
                updateItems(nextPhaseSelect, nextItemSelect);
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        if (currentPhaseSelect && currentPhaseSelect.value) {
            updateItems(currentPhaseSelect, currentItemSelect);
        }
        if (nextPhaseSelect && nextPhaseSelect.value) {
            updateItems(nextPhaseSelect, nextItemSelect);
        }
    });
</script>
{% endblock %}