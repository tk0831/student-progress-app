{% extends 'progress/base.html' %}

{% block title %}ç ”ä¿®ç”Ÿãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">ã“ã‚“ã«ã¡ã¯ã€{{ user.username }}ã•ã‚“</h1>
                    <p class="mt-1 text-sm text-gray-600">
                        {% if user.group %}{{ user.group.name }}{% endif %}
                        {% if user.start_date %} | ç ”ä¿®é–‹å§‹æ—¥: {{ user.start_date }}{% endif %}
                    </p>
                </div>
                <div class="text-right space-y-2">
                    <div class="block">
                        <a href="{% url 'progress_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            ä»Šæ—¥ã®é€²æ—ã‚’è¨˜éŒ²
                        </a>
                    </div>
                    <div class="flex space-x-2">
                        <a href="{% url 'progress_calendar' %}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-0.5 mr-1 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                            ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                        </a>
                        <a href="{% url 'progress_list' %}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-0.5 mr-1 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                            ğŸ“‹ è¨˜éŒ²ä¸€è¦§
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- ç¾åœ¨ã®éšç´š -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full {% if user_stats.current_grade == 'S' %}grade-s{% elif user_stats.current_grade == 'A' %}grade-a{% elif user_stats.current_grade == 'B' %}grade-b{% elif user_stats.current_grade == 'C' %}grade-c{% else %}grade-d{% endif %} flex items-center justify-center">
                            <span class="text-white font-bold text-sm">{{ user_stats.current_grade|default:'A' }}</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">ç¾åœ¨ã®éšç´š</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user_stats.get_current_grade_display|default:'Aç´š' }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµŒéæ—¥æ•° -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">çµŒéæ—¥æ•°</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user_stats.days_elapsed|default:0 }}æ—¥</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç´¯è¨ˆå­¦ç¿’æ™‚é–“ -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">ç´¯è¨ˆå­¦ç¿’æ™‚é–“</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user_stats.total_study_hours|default:0 }}æ™‚é–“</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®Œäº†ç‡ -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">å®Œäº†ç‡</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user_stats.completion_rate|default:0 }}%</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾åœ¨ã®é€²æ— -->
    {% if user_stats.current_phase %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ç¾åœ¨ã®å­¦ç¿’çŠ¶æ³</h3>
            <div class="space-y-3">
                <div>
                    <span class="text-sm font-medium text-gray-500">Phase:</span>
                    <span class="ml-2 text-sm text-gray-900">{{ user_stats.current_phase }}</span>
                </div>
                {% if user_stats.current_item %}
                <div>
                    <span class="text-sm font-medium text-gray-500">ç¾åœ¨ã®é …ç›®:</span>
                    <span class="ml-2 text-sm text-gray-900">{{ user_stats.current_item }}</span>
                </div>
                {% endif %}
                
                <!-- éšç´šå¤‰æ›´äºˆæ¸¬ -->
                {% if user_stats.grade_change_prediction %}
                    {% with prediction=user_stats.grade_change_prediction %}
                    {% if prediction.next_grade %}
                    <div class="mt-4 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                {% if prediction.next_grade == 'S' %}
                                    <span class="text-2xl">ğŸ’</span>
                                {% elif prediction.next_grade == 'A' %}
                                    <span class="text-2xl">ğŸ¥‡</span>
                                {% elif prediction.next_grade == 'B' %}
                                    <span class="text-2xl">ğŸ¥ˆ</span>
                                {% elif prediction.next_grade == 'C' %}
                                    <span class="text-2xl">ğŸ¥‰</span>
                                {% endif %}
                            </div>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-yellow-800">
                                    ğŸ¯ éšç´šã‚¢ãƒƒãƒ—äºˆæ¸¬
                                </p>
                                {% if prediction.days_to_complete_current > 0 %}
                                    {% if prediction.is_current_item_sufficient %}
                                    <p class="text-sm text-yellow-700">
                                        ç¾åœ¨ã®é …ç›®ã‚’<strong>{{ prediction.days_to_complete_current }}æ—¥ä»¥å†…</strong>ã«çµ‚äº†ã§
                                        <span class="font-bold text-yellow-900">{{ prediction.next_grade }}ç´š</span>ã«æ˜‡æ ¼ï¼
                                    </p>
                                    <p class="text-xs text-yellow-600 mt-1">
                                        å®Œäº†é …ç›®: {{ prediction.next_milestone }}
                                    </p>
                                    {% else %}
                                    <p class="text-sm text-yellow-700">
                                        <strong>{{ prediction.days_to_complete_current }}æ—¥ä»¥å†…</strong>ã«å­¦ç¿’é€²ã‚ã¦
                                        <span class="font-bold text-yellow-900">{{ prediction.next_grade }}ç´š</span>ã«æ˜‡æ ¼ï¼
                                    </p>
                                    <p class="text-xs text-yellow-600 mt-1">
                                        ç›®æ¨™é …ç›®: {{ prediction.next_milestone }}ã¾ã§
                                    </p>
                                    {% endif %}
                                {% else %}
                                <p class="text-sm text-green-700">
                                    <span class="font-bold text-green-900">{{ prediction.next_grade }}ç´š</span>ã®æ¡ä»¶é”æˆæ¸ˆã¿ï¼
                                    æ¬¡å›æ›´æ–°ã§æ˜‡æ ¼ã—ã¾ã™ ğŸ‰
                                </p>
                                {% endif %}
                                {% if prediction.completion_percentage %}
                                <div class="mt-2">
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-yellow-700">é€²æ—</span>
                                        <span class="text-yellow-900 font-medium">{{ prediction.completion_percentage }}%</span>
                                    </div>
                                    <div class="mt-1 bg-yellow-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-yellow-400 to-orange-400 h-2 rounded-full transition-all duration-300" style="width: {{ prediction.completion_percentage }}%"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Phaseé€²æ—ä¸€è¦§ -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ğŸ“š ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ é€²æ—</h3>
            <div class="space-y-4">
                {% for phase in phases %}
                <div class="border border-gray-200 rounded-lg {% if user_stats.current_phase.id == phase.id %}bg-blue-50 border-blue-200{% endif %}" id="phase-{{ phase.id }}">
                    <div class="p-4">
                        <div class="flex items-center justify-between cursor-pointer" onclick="togglePhaseItems({{ phase.id }})">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <h4 class="text-md font-medium text-gray-900">{{ phase.name }}</h4>
                                    <svg class="ml-2 h-4 w-4 text-gray-400 transform transition-transform duration-200" id="arrow-{{ phase.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <p class="text-sm text-gray-600">æ¨™æº–æœŸé–“: {{ phase.start_day }}æ—¥ç›®ã€œ{{ phase.end_day }}æ—¥ç›®ï¼ˆ{{ phase.total_days }}æ—¥é–“ï¼‰</p>
                            </div>
                            <div class="text-right ml-4">
                                {% if user_stats.current_phase.id == phase.id %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        ğŸ“– å­¦ç¿’ä¸­
                                    </span>
                                {% elif user_stats.current_phase.phase_number > phase.phase_number %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        âœ… å®Œäº†
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        â³ æœªé–‹å§‹
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- é …ç›®è©³ç´°ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰ -->
                        <div class="mt-4 hidden" id="items-{{ phase.id }}">
                            <div class="border-t pt-4">
                                <h5 class="text-sm font-medium text-gray-700 mb-3">ğŸ“‹ å­¦ç¿’é …ç›®ä¸€è¦§</h5>
                                <div class="grid gap-2" id="items-content-{{ phase.id }}">
                                    <!-- é …ç›®ã¯å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                                    <div class="text-center py-4">
                                        <div class="animate-spin inline-block w-4 h-4 border-2 border-gray-300 border-t-blue-500 rounded-full"></div>
                                        <span class="ml-2 text-sm text-gray-500">é …ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- é€±é–“MVPã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
    {% if current_rankings %}
        {% include 'progress/components/weekly_ranking_widget.html' %}
    {% endif %}

    <!-- æœ€è¿‘ã®é€²æ—è¨˜éŒ² -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">æœ€è¿‘ã®é€²æ—è¨˜éŒ²</h3>
                <a href="{% url 'progress_list' %}" class="text-sm text-primary hover:text-blue-600">å…¨ã¦è¦‹ã‚‹ â†’</a>
            </div>
            
            {% if recent_progress %}
                <div class="space-y-3">
                    {% for progress in recent_progress %}
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ progress.date }}</p>
                                <p class="text-xs text-gray-600">{{ progress.current_item }} - {{ progress.study_hours }}æ™‚é–“</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if progress.current_grade == 'S' %}grade-s text-white{% elif progress.current_grade == 'A' %}grade-a text-white{% elif progress.current_grade == 'B' %}grade-b text-white{% elif progress.current_grade == 'C' %}grade-c text-white{% else %}grade-d text-white{% endif %}">
                                    {{ progress.get_current_grade_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">ã¾ã é€²æ—è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- é€±åˆã‚ãƒ­ã‚°ã‚¤ãƒ³æ¼”å‡ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="weekStartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-xl bg-white">
        <div class="mt-3 text-center">
            <!-- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 animate-pulse mb-4">
                <span class="text-white text-4xl">ğŸŒŸ</span>
            </div>
            
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-2">æ–°ã—ã„é€±ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼</h3>
            
            <div class="mt-4 px-7 py-3">
                <p class="text-lg text-gray-600 mb-4" id="weeklyMessage">
                    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JavaScriptã§å‹•çš„ã«è¨­å®š -->
                </p>
                
                <!-- å…ˆé€±ã®MVPè¡¨ç¤º -->
                <div id="lastWeekMVP" class="mt-6 mb-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">ğŸ† å…ˆé€±ã®é€±é–“MVP</h4>
                    <div class="space-y-2" id="mvpList">
                        <!-- MVPãƒªã‚¹ãƒˆã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <button id="closeModalBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-300 transition-all duration-200">
                    ä»Šé€±ã‚‚é ‘å¼µã‚Šã¾ã™ï¼
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// é€±åˆã‚ãƒ­ã‚°ã‚¤ãƒ³æ¼”å‡º
document.addEventListener('DOMContentLoaded', function() {
    // ã­ãã‚‰ã„ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
    const weeklyMessages = [
        "å…ˆé€±ã‚‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ä»Šé€±ã‚‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ğŸ’ª",
        "æ–°ã—ã„é€±ã®å§‹ã¾ã‚Šã§ã™ã€‚å…ˆé€±ã®åŠªåŠ›ã¯å¿…ãšå®Ÿã‚’çµã³ã¾ã™ğŸŒ±",
        "ç´ æ™´ã‚‰ã—ã„ä¸€é€±é–“ã®ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ï¼ä»Šé€±ã‚‚ç€å®Ÿã«å‰é€²ã—ã¾ã—ã‚‡ã†ğŸš€",
        "å…ˆé€±ã®é ‘å¼µã‚ŠãŒä»Šé€±ã®ç³§ã«ãªã‚Šã¾ã™ã€‚ä»Šé€±ã‚‚å¿œæ´ã—ã¦ã„ã¾ã™ğŸ“š",
        "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ä»Šé€±ã‚‚è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ğŸŒŸ"
    ];

    // é€±ã®æœ€åˆã®ãƒ­ã‚°ã‚¤ãƒ³ã‹ãƒã‚§ãƒƒã‚¯
    const lastLoginWeek = localStorage.getItem('lastLoginWeek');
    const currentWeek = getWeekNumber(new Date());
    
    if (lastLoginWeek !== currentWeek.toString()) {
        // é€±ã®æœ€åˆã®ãƒ­ã‚°ã‚¤ãƒ³
        localStorage.setItem('lastLoginWeek', currentWeek.toString());
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¸æŠ
        const randomMessage = weeklyMessages[Math.floor(Math.random() * weeklyMessages.length)];
        document.getElementById('weeklyMessage').textContent = randomMessage;
        
        // å…ˆé€±ã®MVPãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        fetch('/api/last-week-mvp/')
            .then(response => response.json())
            .then(data => {
                if (data.mvp_list && data.mvp_list.length > 0) {
                    const mvpListEl = document.getElementById('mvpList');
                    mvpListEl.innerHTML = '';
                    
                    data.mvp_list.forEach((mvp, index) => {
                        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                        const mvpItem = document.createElement('div');
                        mvpItem.className = 'flex items-center justify-between p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg';
                        mvpItem.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${medal}</span>
                                <span class="font-medium text-gray-800">${mvp.username}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-sm font-bold text-orange-600">${mvp.completed_days}æ—¥åˆ†å®Œäº†</span>
                                <span class="text-xs text-gray-600 block">åŠ¹ç‡ ${mvp.efficiency}%</span>
                            </div>
                        `;
                        mvpListEl.appendChild(mvpItem);
                    });
                    
                    document.getElementById('lastWeekMVP').classList.remove('hidden');
                }
            })
            .catch(error => console.error('MVP data fetch error:', error));
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆå°‘ã—é…å»¶ã•ã›ã¦æ¼”å‡ºåŠ¹æœã‚’é«˜ã‚ã‚‹ï¼‰
        setTimeout(() => {
            document.getElementById('weekStartModal').classList.remove('hidden');
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³åŠ¹æœ
            document.getElementById('weekStartModal').style.opacity = '0';
            document.getElementById('weekStartModal').style.transition = 'opacity 0.5s ease-in-out';
            setTimeout(() => {
                document.getElementById('weekStartModal').style.opacity = '1';
            }, 50);
        }, 500);
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.getElementById('closeModalBtn').addEventListener('click', function() {
        const modal = document.getElementById('weekStartModal');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 500);
    });
});

// é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getWeekNumber(date) {
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

// Phaseé …ç›®ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
function togglePhaseItems(phaseId) {
    const itemsContainer = document.getElementById(`items-${phaseId}`);
    const arrow = document.getElementById(`arrow-${phaseId}`);
    const itemsContent = document.getElementById(`items-content-${phaseId}`);
    
    if (itemsContainer.classList.contains('hidden')) {
        // é …ç›®ã‚’è¡¨ç¤ºã™ã‚‹
        itemsContainer.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        
        // é …ç›®ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¿è¾¼ã‚€
        if (itemsContent.innerHTML.includes('é …ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...')) {
            loadPhaseItems(phaseId);
        }
    } else {
        // é …ç›®ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        itemsContainer.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Phaseé …ç›®ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€é–¢æ•°
function loadPhaseItems(phaseId) {
    const itemsContent = document.getElementById(`items-content-${phaseId}`);
    
    fetch(`/api/phase-items/?phase_id=${phaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.items && data.items.length > 0) {
                itemsContent.innerHTML = '';
                const currentInfo = data.current_info;
                
                data.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    
                    // APIã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã§é€²æ—çŠ¶æ³ã‚’åˆ¤å®š
                    const isCurrent = currentInfo.current_item_id === item.id;
                    const isCompleted = item.completed;
                    
                    let statusBadge = '';
                    let daysInfo = '';
                    
                    if (isCurrent) {
                        statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">ğŸ“– å­¦ç¿’ä¸­</span>';
                    } else if (isCompleted) {
                        statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">âœ… å®Œäº†</span>';
                        // å®Œäº†ã—ãŸé …ç›®ã¯æ‰€è¦æ—¥æ•°ã‚’è¡¨ç¤º
                        if (item.days_taken) {
                            const estimatedDays = parseInt(item.estimated_days) || 1;
                            const daysTaken = parseInt(item.days_taken) || 1;
                            const efficiency = Math.round((estimatedDays / daysTaken) * 100);
                            let efficiencyColor = 'text-gray-600';
                            let efficiencyEmoji = '';
                            
                            // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                            console.log(`Item: ${item.code}`, {
                                estimated_days: item.estimated_days,
                                days_taken: item.days_taken,
                                calculated_efficiency: efficiency,
                                raw_calculation: item.estimated_days / item.days_taken * 100,
                                debug_info: item.debug_info
                            });
                            
                            if (efficiency >= 150) {
                                efficiencyColor = 'text-purple-600 font-semibold';
                                efficiencyEmoji = 'ğŸš€';
                            } else if (efficiency >= 120) {
                                efficiencyColor = 'text-green-600 font-semibold';
                                efficiencyEmoji = 'â­';
                            } else if (efficiency >= 100) {
                                efficiencyColor = 'text-blue-600';
                                efficiencyEmoji = 'ğŸ‘';
                            } else if (efficiency >= 80) {
                                efficiencyColor = 'text-teal-600';
                            } else if (efficiency >= 50) {
                                efficiencyColor = 'text-gray-600';
                            } else {
                                efficiencyColor = 'text-red-600';
                                efficiencyEmoji = 'ğŸ’ª';
                            }
                            
                            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å«ã‚€è¡¨ç¤º
                            daysInfo = `
                                <p class="text-xs ${efficiencyColor} mt-1">
                                    å®Ÿéš›: ${daysTaken}æ—¥ (åŠ¹ç‡: ${efficiency}% ${efficiencyEmoji})
                                </p>
                                <p class="text-xs text-gray-400">
                                    [æ¨™æº–: ${estimatedDays}æ—¥ / å®Ÿéš›: ${daysTaken}æ—¥ = ${efficiency}%]
                                </p>
                            `;
                        }
                    } else {
                        statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">â³ æœªé–‹å§‹</span>';
                    }
                    
                    itemElement.innerHTML = `
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${item.code}: ${item.name}</p>
                            <p class="text-xs text-gray-500">æ¨™æº–å­¦ç¿’æ™‚é–“: ${item.estimated_days || 1}æ—¥</p>
                            ${daysInfo}
                        </div>
                        <div class="text-right ml-4">
                            ${statusBadge}
                        </div>
                    `;
                    itemsContent.appendChild(itemElement);
                });
            } else {
                itemsContent.innerHTML = '<div class="text-center py-4 text-gray-500">é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            }
        })
        .catch(error => {
            console.error('Error loading phase items:', error);
            itemsContent.innerHTML = '<div class="text-center py-4 text-red-500">é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
}
</script>
{% endblock %}